$OpenBSD: patch-examples_autochangers_chio-changer-openbsd,v 1.3 2013/03/03 12:53:21 ajacoutot Exp $

http://bugs.bacula.org/view.php?id=1937
http://bugs.bacula.org/view.php?id=1984

--- examples/autochangers/chio-changer-openbsd.orig	Thu Sep 13 10:51:19 2012
+++ examples/autochangers/chio-changer-openbsd	Sun Mar  3 13:51:01 2013
@@ -23,11 +23,11 @@
 #      the chio exit code or a 0. If the script exits with a non-zero
 #      exit code, Bacula will assume the request failed.
 
-CHIO=/bin/chio
-
 # time (in seconds) for the unit to settle after (un)loading a tape
 SLEEP=1
 
+CHIO=/bin/chio
+
 usage() {
 	echo "usage: ${0##*/} ctl-device command [slot archive-device drive-index]"
 }
@@ -85,7 +85,6 @@ case ${cmd} in 
 		[ ${rtn} -eq 0 ] && sleep ${SLEEP}
 		exit ${rtn}
 		;;
-
 	load)
 		${CHIO} -f ${ctl} move slot $((${slot} - 1)) drive ${drive}
 		rtn=$?
@@ -95,20 +94,35 @@ case ${cmd} in 
 	list)
 		${CHIO} -f ${ctl} status -v slot | \
 			sed -ne 's/^slot *\([0-9]*:\).*FULL.*voltag.*<\(.*\):.*/\1\2/p' | \
-			awk -F: '{print $1 + 1 ":" $2 }'
+			awk -F: '{ print $1 + 1 ":" $2 }'
 		exit $?
 		;;
-
 	listall)
-		echo "The listall command is not implemented on OpenBSD."
-		exit 1
-		;;
+		# XXX only one drive is queried
+		_list=$(${0} ${1} list)
+		_loaded_s=$(${0} ${1} loaded ${slot} ${device} ${drive})
+		_loaded_t=$(${CHIO} -f ${ctl} status -v | grep "drive ${drive}" | awk '{ print $NF }' | sed -e 's,<,,' -e 's,:.*,,')
 
+		[ -n "${_list}" -a -n "${_loaded_s}" -a -n "${_loaded_t}" ] || exit 1
+
+		(for i in ${_list}; do
+			echo "S:${i}" | sed 's/\(.*\):/\1:F:/'
+		done
+		echo S:${_loaded_s}:E
+		if [ "${_loaded_s}" -ne 0 ]; then
+			echo D:${drive}:F:${_loaded_s}:${_loaded_t}
+		else
+			echo D:${drive}:E
+		fi) | sort
+		;;
 	loaded)
-		local _slot=`${CHIO} -f ${ctl} status -v | egrep '^slot.*<ACCESS> voltag: <:[0-9]>$' | awk '{ print $2 }' | awk -F: '{ print $1 + 1 }'`
-		[ -z "${_slot}" ] && _slot=0
-		echo ${_slot}
-		exit $?
+		# XXX output the first empty slot if the drive is loaded
+		_slot=$(${CHIO} -f ${ctl} status -v | egrep '^slot.*<ACCESS> voltag: <:[0-9]>$' | awk '{ print $2 }' | awk -F: '{ print $1 + 1 }')
+		rtn=$?
+		_loaded=$(${CHIO} -f ${ctl} status -v | egrep "^drive ${drive}: <ACCESS,FULL> voltag: <.*:[0-9]>")
+		[ -z "${_slot}" -o -z "${_loaded}" ] && _slot=0
+		echo ${_slot} | awk '{ print $1 }'
+		exit ${rtn}
 		;;
 	slots)
 		${CHIO} -f ${ctl} params | awk "/slots/{print \$2}"

$OpenBSD: patch-lib_puppet_provider_package_openbsd_rb,v 1.3 2013/08/07 07:19:30 jasper Exp $

From a5b8b96f703d932b90ce7461b18076bb32ee85b3 Mon Sep 17 00:00:00 2001
From: Jasper Lievisse Adriaanse <jasper@humppa.nl>
Date: Tue, 23 Jul 2013 16:55:55 +0200
Subject: Enhance OpenBSD pkg.conf handling

From ee14796e05bb05a6829644827e510b2b8e8076d4 Mon Sep 17 00:00:00 2001
From: Jasper Lievisse Adriaanse <jasper@humppa.nl>
Date: Thu, 1 Aug 2013 17:32:46 +0200
Subject: (22023) Implement :purgeable feature for OpenBSD package provider

From 19b0e78df7e010f0af111fda083fd7f87499f952 Mon Sep 17 00:00:00 2001
From: Jasper Lievisse Adriaanse <jasper@humppa.nl>
Date: Wed, 31 Jul 2013 12:20:15 +0200
Subject: (22004) Fix regex for retrieving flavor.

--- lib/puppet/provider/package/openbsd.rb.orig	Wed Aug  7 09:16:36 2013
+++ lib/puppet/provider/package/openbsd.rb	Wed Aug  7 09:16:19 2013
@@ -17,7 +17,7 @@ Puppet::Type.type(:package).provide :openbsd, :parent 
     begin
       execpipe(listcmd) do |process|
         # our regex for matching pkg_info output
-        regex = /^(.*)-(\d[^-]*)[-]?(\D*)(.*)$/
+        regex = /^(.*)-(\d[^-]*)[-]?(\w*)(.*)$/
         fields = [:name, :ensure, :flavor ]
         hash = {}
 
@@ -52,15 +52,18 @@ Puppet::Type.type(:package).provide :openbsd, :parent 
     [command(:pkginfo), "-a"]
   end
 
-  def install
-    should = @resource.should(:ensure)
-
+  def parse_pkgconf
     unless @resource[:source]
       if File.exist?("/etc/pkg.conf")
         File.open("/etc/pkg.conf", "rb").readlines.each do |line|
           if matchdata = line.match(/^installpath\s*=\s*(.+)\s*$/i)
             @resource[:source] = matchdata[1]
-            break
+          elsif matchdata = line.match(/^installpath\s*\+=\s*(.+)\s*$/i)
+            if @resource[:source].nil?
+              @resource[:source] = matchdata[1]
+            else
+              @resource[:source] += ":" + matchdata[1]
+            end
           end
         end
 
@@ -72,8 +75,14 @@ Puppet::Type.type(:package).provide :openbsd, :parent 
         raise Puppet::Error,
         "You must specify a package source or configure an installpath in /etc/pkg.conf"
       end
-    end
+    end  
+  end
 
+  def install
+    should = @resource.should(:ensure)
+
+    parse_pkgconf
+
     if @resource[:source][-1,1] == ::File::SEPARATOR
       e_vars = { 'PKG_PATH' => @resource[:source] }
       full_name = [ @resource[:name], get_version || @resource[:ensure], @resource[:flavor] ].join('-').chomp('-').chomp('-')
@@ -122,5 +131,9 @@ Puppet::Type.type(:package).provide :openbsd, :parent 
 
   def uninstall
     pkgdelete @resource[:name]
+  end
+
+  def purge
+    pkgdelete "-c", "-q", @resource[:name]
   end
 end

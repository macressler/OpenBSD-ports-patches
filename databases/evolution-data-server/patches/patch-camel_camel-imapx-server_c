$OpenBSD: patch-camel_camel-imapx-server_c,v 1.3 2013/05/14 11:01:43 ajacoutot Exp $

From d6b200b9e83f6ce07f3287c5d2ac7f4e0ba19fa9 Mon Sep 17 00:00:00 2001
From: Milan Crha <mcrha@redhat.com>
Date: Mon, 13 May 2013 14:29:58 +0000
Subject: Bug #699811 - Moved IMAPx messages reappear

--- camel/camel-imapx-server.c.orig	Wed May  8 19:40:04 2013
+++ camel/camel-imapx-server.c	Tue May 14 12:13:44 2013
@@ -6674,10 +6674,15 @@ imapx_command_sync_changes_done (CamelIMAPXServer *is,
 			if (!xinfo)
 				continue;
 
-			if (data->remove_deleted_flags)
-				xinfo->info.flags &= ~CAMEL_MESSAGE_DELETED;
 			xinfo->server_flags = xinfo->info.flags & CAMEL_IMAPX_SERVER_FLAGS;
-			xinfo->info.flags &= ~CAMEL_MESSAGE_FOLDER_FLAGGED;
+			if (!data->remove_deleted_flags ||
+			    !(xinfo->info.flags & CAMEL_MESSAGE_DELETED)) {
+				xinfo->info.flags &= ~CAMEL_MESSAGE_FOLDER_FLAGGED;
+			} else {
+				/* to stare back the \Deleted flag */
+				xinfo->server_flags &= ~CAMEL_MESSAGE_DELETED;
+				xinfo->info.flags |= CAMEL_MESSAGE_FOLDER_FLAGGED;
+			}
 			xinfo->info.dirty = TRUE;
 			camel_flag_list_copy (&xinfo->server_user_flags, &xinfo->info.user_flags);
 

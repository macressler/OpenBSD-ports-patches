$OpenBSD: patch-common_compat_c,v 1.1 2013/03/19 16:07:49 ajacoutot Exp $

From 7c27e9fbbe86b3268065f248eab2d6964983a715 Mon Sep 17 00:00:00 2001
From: Stef Walter <stefw@gnome.org>
Date: Tue, 19 Mar 2013 13:50:32 +0000
Subject: trust: Don't use POSIX or GNU basename()

--- common/compat.c.orig	Mon Mar 11 18:06:27 2013
+++ common/compat.c	Tue Mar 19 14:55:13 2013
@@ -148,31 +148,39 @@ getprogname (void)
 
 #endif /* HAVE_GETPROGNAME */
 
-#ifndef HAVE_BASENAME
-
 char *
-basename (const char *name)
+p11_basename (const char *name)
 {
-	char *p;
 #ifdef OS_WIN32
-	char *p2;
+	static const char *delims = "/\\";
+#else
+	static const char *delims = "/";
 #endif
 
-	if (!name || name[0] == '\0')
-		return ".";
+	const char *end;
+	const char *beg;
 
-	p = strrchr (name, '/');
-#ifdef OS_WIN32
-	p2 = strrchr (name, '\\');
-	if (p2 > p)
-		p = p2;
-#endif
-	if (p != NULL)
-		return p + 1;
-	return (char *)name;
-}
+	if (name == NULL)
+		return NULL;
 
-#endif /* HAVE_BASENAME */
+	/* Any trailing slashes */
+	end = name + strlen (name);
+	while (end != name) {
+		if (!strchr (delims, *(end - 1)))
+			break;
+		end--;
+	}
+
+	/* Find the last slash after those */
+	beg = end;
+	while (beg != name) {
+		if (strchr (delims, *(beg - 1)))
+			break;
+		beg--;
+	}
+
+	return strndup (beg, end - beg);
+}
 
 #ifdef OS_UNIX
 #include <sys/stat.h>

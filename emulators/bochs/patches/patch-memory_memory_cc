$OpenBSD: patch-memory_memory_cc,v 1.4 2011/12/13 08:46:51 giovanni Exp $

Fix for busmaster DMA transfers from device to memory

--- memory/memory.cc.orig	Sun Nov 27 11:12:19 2011
+++ memory/memory.cc	Wed Dec  7 01:55:19 2011
@@ -42,7 +42,7 @@ void BX_MEM_C::writePhysicalPage(BX_CPU_C *cpu, bx_phy
   bx_phy_address a20addr = A20ADDR(addr);
   struct memory_handler_struct *memory_handler = NULL;
 
-  // Note: accesses should always be contained within a single page now
+  // Note: accesses should always be contained within a single page
   if ((addr>>12) != ((addr+len-1)>>12)) {
     BX_PANIC(("writePhysicalPage: cross page access at address 0x" FMT_PHY_ADDRX ", len=%d", addr, len));
   }
@@ -195,7 +195,7 @@ void BX_MEM_C::readPhysicalPage(BX_CPU_C *cpu, bx_phy_
   bx_phy_address a20addr = A20ADDR(addr);
   struct memory_handler_struct *memory_handler = NULL;
 
-  // Note: accesses should always be contained within a single page now
+  // Note: accesses should always be contained within a single page
   if ((addr>>12) != ((addr+len-1)>>12)) {
     BX_PANIC(("readPhysicalPage: cross page access at address 0x" FMT_PHY_ADDRX ", len=%d", addr, len));
   }
@@ -362,6 +362,43 @@ inc_one:
     }
     else {
       memset(data, 0xFF, len);
+    }
+  }
+}
+
+void BX_MEM_C::dmaReadPhysicalPage(bx_phy_address addr, unsigned len, Bit8u *data)
+{
+  // Note: accesses should always be contained within a single page
+  if ((addr>>12) != ((addr+len-1)>>12)) {
+    BX_PANIC(("dmaReadPhysicalPage: cross page access at address 0x" FMT_PHY_ADDRX ", len=%d", addr, len));
+  }
+
+  Bit8u *memptr = getHostMemAddr(NULL, addr, BX_READ);
+  if (memptr != NULL) {
+    memcpy(data, memptr, len);
+  }
+  else {
+    for (unsigned i=0;i < len; i++) {
+      readPhysicalPage(NULL, addr+i, 1, &data[i]);
+    }
+  }
+}
+
+void BX_MEM_C::dmaWritePhysicalPage(bx_phy_address addr, unsigned len, Bit8u *data)
+{
+  // Note: accesses should always be contained within a single page
+  if ((addr>>12) != ((addr+len-1)>>12)) {
+    BX_PANIC(("dmaWritePhysicalPage: cross page access at address 0x" FMT_PHY_ADDRX ", len=%d", addr, len));
+  }
+
+  Bit8u *memptr = getHostMemAddr(NULL, addr, BX_WRITE);
+  if (memptr != NULL) {
+    pageWriteStampTable.decWriteStamp(addr);
+    memcpy(memptr, data, len);
+  }
+  else {
+    for (unsigned i=0;i < len; i++) {
+      writePhysicalPage(NULL, addr+i, 1, &data[i]);
     }
   }
 }

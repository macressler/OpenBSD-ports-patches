$OpenBSD: patch-src_stream_output_announce_c,v 1.1 2011/12/23 15:01:59 sthen Exp $

Handle SAP_Add() errors.

--- src/stream_output/announce.c.orig	Thu Dec 22 05:20:46 2011
+++ src/stream_output/announce.c	Thu Dec 22 05:21:53 2011
@@ -100,7 +100,13 @@ sout_AnnounceRegisterSDP( vlc_object_t *obj, const cha
         goto error;
 
     msg_Dbg (obj, "adding SAP session");
-    SAP_Add (p_sap, p_session );
+    if (SAP_Add (p_sap, p_session))
+    {
+        vlc_mutex_lock (&sap_mutex);
+        vlc_object_release ((vlc_object_t *)p_sap);
+        vlc_mutex_unlock (&sap_mutex);
+        goto error;
+    }
     return p_session;
 
 error:

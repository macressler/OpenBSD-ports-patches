$OpenBSD: patch-configure_ac,v 1.11 2013/09/27 14:04:46 jasper Exp $

Make Network Manager support optional.
https://bugzilla.gnome.org/show_bug.cgi?id=679871

--- configure.ac.orig	Tue Sep 24 22:04:57 2013
+++ configure.ac	Fri Sep 27 15:28:37 2013
@@ -91,8 +91,6 @@ SHARED_PCS="gio-unix-2.0 >= $GIO_MIN_VERSION
             libcanberra libcanberra-gtk3
             telepathy-glib >= $TELEPATHY_GLIB_MIN_VERSION
             polkit-agent-1 >= $POLKIT_MIN_VERSION
-            libnm-glib libnm-util >= $NETWORKMANAGER_MIN_VERSION
-            libnm-gtk >= $NETWORKMANAGER_MIN_VERSION
             libsecret-unstable gcr-base-3 >= $GCR_MIN_VERSION"
 
 PKG_CHECK_MODULES(GNOME_SHELL, $SHARED_PCS)
@@ -128,6 +126,24 @@ PKG_CHECK_EXISTS([gnome-bluetooth-1.0 >= 3.9.0],
 	[AC_DEFINE([HAVE_BLUETOOTH],[0])
 	 AC_SUBST([HAVE_BLUETOOTH],[0])
 	 AC_MSG_RESULT([no])])
+
+network_manager=false
+AC_MSG_CHECKING([for Network Manager support])
+PKG_CHECK_EXISTS([libnm-glib libnm-util libnm-gtk],
+        [NM_LIBS=`$PKG_CONFIG --libs libnm-glib libnm-util libnm-gtk`
+	 NM_CFLAGS=`$PKG_CONFIG --cflags libnm-glib libnm-util libnm-gtk`
+	 AC_SUBST([NM_LIBS],["$NM_LIBS"])
+	 AC_SUBST([NM_CFLAGS],["$NM_CFLAGS"])
+	 AC_DEFINE([HAVE_NETWORK_MANAGER],[1],[Define to 1 if you have Network Manager])
+	 AC_SUBST([HAVE_NETWORK_MANAGER],[1])
+	 AC_MSG_RESULT([yes])
+	 network_manager=true],
+	[AC_DEFINE([HAVE_NETWORK_MANAGER],[0])
+	 AC_SUBST([HAVE_NETWORK_MANAGER],[0])
+	 AC_MSG_RESULT([no])])
+
+AM_CONDITIONAL(NETWORK_MANAGER, $network_manager)
+GNOME_SHELL=$GNOME_SHELL $NM_LIBS
 
 PKG_CHECK_MODULES(CALENDAR_SERVER, libecal-1.2 >= $LIBECAL_MIN_VERSION libedataserver-1.2 >= $LIBEDATASERVER_MIN_VERSION gio-2.0)
 AC_SUBST(CALENDAR_SERVER_CFLAGS)

$OpenBSD: patch-daemon_gvfsdaemon_c,v 1.2 2014/01/23 14:16:10 ajacoutot Exp $

From 2909ef002746201a83922fdd1c5efad6766347f8 Mon Sep 17 00:00:00 2001
From: Antoine Jacoutot <ajacoutot@gnome.org>
Date: Thu, 23 Jan 2014 13:40:32 +0000
Subject: gvfsdaemon: properly remove socket_dir

--- daemon/gvfsdaemon.c.orig	Thu Nov  7 16:12:17 2013
+++ daemon/gvfsdaemon.c	Thu Jan 23 14:39:25 2014
@@ -598,10 +598,15 @@ static void
 new_connection_data_free (void *memory)
 {
   NewConnectionData *data = memory;
+  gchar *socket;
   
   /* Remove the socket and dir after connected */
-  if (data->socket_dir) 
+  if (data->socket_dir) {
+    socket = g_strdup_printf ("%s/socket", data->socket_dir);
+    g_unlink (socket);
+    g_free (socket);
     rmdir (data->socket_dir);
+  }
 
   g_free (data->socket_dir);
   g_free (data);
@@ -900,13 +905,8 @@ handle_get_connection (GVfsDBusDaemon *object,
   return TRUE;
 
  error_out:
-  g_free (data);
+  new_connection_data_free (data);
   g_free (address1);
-  if (socket_dir)
-    {
-      rmdir (socket_dir);
-      g_free (socket_dir);
-    }
   return TRUE;
 }
 

$OpenBSD: patch-panels_printers_cc-printers-panel_c,v 1.6 2012/08/04 14:49:52 ajacoutot Exp $

https://bugzilla.gnome.org/show_bug.cgi?id=679759

--- panels/printers/cc-printers-panel.c.orig	Sat Jul 28 17:57:48 2012
+++ panels/printers/cc-printers-panel.c	Sat Jul 28 17:58:14 2012
@@ -58,6 +58,16 @@ G_DEFINE_DYNAMIC_TYPE (CcPrintersPanel, cc_printers_pa
 
 #define CUPS_STATUS_CHECK_INTERVAL 5
 
+#if (CUPS_VERSION_MAJOR > 1) || (CUPS_VERSION_MINOR > 5)
+#define HAVE_CUPS_1_6 1
+#endif
+
+#ifndef HAVE_CUPS_1_6
+#define ippGetState(ipp) ipp->state
+#define ippGetStatusCode(ipp) ipp->request.status.status_code
+#define ippGetString(attr, element, language) attr->values[element].string.text
+#endif
+
 struct _CcPrintersPanelPrivate
 {
   GtkBuilder *builder;
@@ -311,7 +321,7 @@ on_cups_notification (GDBusConnection *connection,
 
           if (response)
             {
-              if (response->request.status.status_code <= IPP_OK_CONFLICT)
+              if (ippGetStatusCode (response) <= IPP_OK_CONFLICT)
                 {
                   ipp_attribute_t *attr_username = NULL;
                   ipp_attribute_t *attr_printer_uri = NULL;
@@ -319,12 +329,12 @@ on_cups_notification (GDBusConnection *connection,
                   attr_username = ippFindAttribute(response, "job-originating-user-name", IPP_TAG_NAME);
                   attr_printer_uri = ippFindAttribute(response, "job-printer-uri", IPP_TAG_URI);
                   if (attr_username && attr_printer_uri &&
-                      g_strcmp0 (attr_username->values[0].string.text, cupsUser ()) == 0 &&
-                      g_strrstr (attr_printer_uri->values[0].string.text, "/") != 0 &&
+                      g_strcmp0 (ippGetString (attr_username, 0, NULL), cupsUser ()) == 0 &&
+                      g_strrstr (ippGetString (attr_printer_uri, 0, NULL), "/") != 0 &&
                       priv->current_dest >= 0 &&
                       priv->current_dest < priv->num_dests &&
                       priv->dests != NULL &&
-                      g_strcmp0 (g_strrstr (attr_printer_uri->values[0].string.text, "/") + 1,
+                      g_strcmp0 (g_strrstr (ippGetString (attr_printer_uri, 0, NULL), "/") + 1,
                                  priv->dests[priv->current_dest].name) == 0)
                     actualize_jobs_list (self);
                 }
@@ -2200,7 +2210,7 @@ test_page_cb (GtkButton *button,
   if (printer_name)
     {
       const gchar  *const dirs[] = { "/usr/share/cups",
-                                     "/usr/local/share/cups",
+                                     "${LOCALBASE}/share/cups",
                                      NULL };
       const gchar  *testprint[] = { "%s/data/testprint",
                                     "%s/data/testprint.ps",
@@ -2288,7 +2298,7 @@ test_page_cb (GtkButton *button,
 
       if (response)
         {
-          if (response->state == IPP_ERROR)
+          if (ippGetState(response) == IPP_ERROR)
             g_warning ("An error has occured during printing of test page.");
           ippDelete (response);
         }

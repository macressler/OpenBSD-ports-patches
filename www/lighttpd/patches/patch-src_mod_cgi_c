$OpenBSD: patch-src_mod_cgi_c,v 1.5 2012/04/28 09:25:25 sthen Exp $

Fix splitting :port with IPv6.

--- src/mod_cgi.c.orig	Sun Dec 18 07:52:52 2011
+++ src/mod_cgi.c	Mon Apr 23 00:13:55 2012
@@ -811,8 +811,14 @@ static int cgi_create_env(server *srv, connection *con
 
 		if (!buffer_is_empty(con->server_name)) {
 			size_t len = con->server_name->used - 1;
-			char *colon = strchr(con->server_name->ptr, ':');
-			if (colon) len = colon - con->server_name->ptr;
+
+			if (con->server_name->ptr[0] == '[') {
+				const char *colon = strstr(con->server_name->ptr, "]:");
+				if (colon) len = (colon + 1) - con->server_name->ptr;
+			} else {
+				const char *colon = strchr(con->server_name->ptr, ':');
+				if (colon) len = colon - con->server_name->ptr;
+			}
 
 			cgi_env_add(&env, CONST_STR_LEN("SERVER_NAME"), con->server_name->ptr, len);
 		} else {

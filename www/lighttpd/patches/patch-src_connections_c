$OpenBSD: patch-src_connections_c,v 1.19 2011/12/20 22:27:28 sthen Exp $

let HEAD for 0-byte files return the Content-Length

--- src/connections.c.orig	Wed Nov 30 12:42:45 2011
+++ src/connections.c	Tue Dec 20 16:33:10 2011
@@ -567,8 +567,10 @@ static int connection_handle_write_prepare(server *srv
 				if (NULL != (ds = (data_string*) array_get_element(con->response.headers, "Content-Length"))) {
 					buffer_reset(ds->value); /* Headers with empty values are ignored for output */
 				}
-			} else if (qlen > 0 || con->request.http_method != HTTP_METHOD_HEAD) {
-				/* qlen = 0 is important for Redirects (301, ...) as they MAY have
+			} else if (qlen >= 0) {
+				/* the Content-Length header has to be >= 0 to be valid.
+				 *
+				 * qlen = 0 is important for Redirects (301, ...) as they MAY have
 				 * a content. Browsers are waiting for a Content otherwise
 				 */
 				buffer_copy_off_t(srv->tmp_buf, qlen);
